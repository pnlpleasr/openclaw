# OpenClaw Docker Compose Configuration
#
# Two services:
#   - openclaw-gateway: long-running daemon that handles messaging channels,
#     agent orchestration, and sandbox container management
#   - openclaw-cli: one-shot CLI for onboarding, channel setup, and admin tasks
#
# Env vars are loaded from the project-level .env file (generated by docker-setup.sh).
# Secrets originate from ~/.openclaw/.env and are persisted here via upsert_env.
#
# See docker-setup-guide.md for full documentation.

services:
  openclaw-gateway:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    # Run as the host user's UID/GID for bind-mount compatibility.
    # Critical on macOS where the default user is UID 501, not 1000.
    # docker-setup.sh auto-detects via `id -u`/`id -g`.
    user: "${OPENCLAW_UID:-1000}:${OPENCLAW_GID:-1000}"
    # GID 0 (root group) grants access to /var/run/docker.sock inside the
    # container, which is needed to spawn sibling sandbox containers.
    group_add:
      - "0"
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      # Optional skill/channel secrets loaded from ~/.openclaw/.env.
      # Default to empty when unset — all consumers must treat empty string
      # the same as undefined (use hasNonEmptyString, not !== undefined).
      # These are NOT forwarded to sandbox containers — the env var sanitizer
      # (sanitize-env-vars.ts) blocks *_TOKEN, *_API_KEY patterns.
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      GOOGLE_PLACES_API_KEY: ${GOOGLE_PLACES_API_KEY:-}
      NOTION_API_KEY: ${NOTION_API_KEY:-}
      OPENAI_WHISPER_API_KEY: ${OPENAI_WHISPER_API_KEY:-}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
    volumes:
      # Primary config and workspace mounts (canonical container paths)
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
      # Duplicate identity mounts at the original host paths. These exist
      # because openclaw.json stores absolute host paths — when the gateway
      # spawns sandbox containers, the Docker daemon resolves mount sources
      # on the host, so paths must be valid from both perspectives.
      - ${OPENCLAW_CONFIG_DIR}:${OPENCLAW_CONFIG_DIR}
      - ${OPENCLAW_WORKSPACE_DIR}:${OPENCLAW_WORKSPACE_DIR}
      # Docker socket for spawning sibling sandbox containers.
      # Security tradeoff: grants full Docker daemon access. The gateway
      # mitigates this via validate-sandbox-security.ts (blocks dangerous
      # mounts, host networking, and unconfined seccomp/apparmor).
      - /var/run/docker.sock:/var/run/docker.sock
      # Obsidian vault (or any knowledge base directory). Uses long-form
      # syntax because iCloud paths contain spaces.
      - type: bind
        source: "${OPENCLAW_VAULT_DIR}"
        target: /home/node/.openclaw/workspace/vault
    # Loopback-only binding prevents the gateway from being accessible
    # on the LAN. Without 127.0.0.1, Docker publishes on 0.0.0.0 and
    # bypasses host firewall rules (iptables/ufw on Linux).
    ports:
      - "127.0.0.1:${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "127.0.0.1:${OPENCLAW_BRIDGE_PORT:-18790}:18790"
    init: true
    restart: unless-stopped
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "${OPENCLAW_GATEWAY_BIND:-lan}",
        "--port",
        "18789",
      ]

  # One-shot CLI for onboarding, channel setup, and admin commands.
  # Does NOT mount docker.sock or identity paths — the CLI doesn't
  # manage sandbox containers.
  openclaw-cli:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    user: "${OPENCLAW_UID:-1000}:${OPENCLAW_GID:-1000}"
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      GOOGLE_PLACES_API_KEY: ${GOOGLE_PLACES_API_KEY:-}
      NOTION_API_KEY: ${NOTION_API_KEY:-}
      OPENAI_WHISPER_API_KEY: ${OPENAI_WHISPER_API_KEY:-}
      BROWSER: echo
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
      - type: bind
        source: "${OPENCLAW_VAULT_DIR}"
        target: /home/node/.openclaw/workspace/vault
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "dist/index.js"]
